Sei responsabile di {aspect}. Produci SOLO JSON che corrisponda allo schema fornito.
Non ripetere il prompt e non aggiungere intestazioni, commenti o campi che non appartengono allo schema.

Regole comuni:
1) Lingua & stile
   - Rileva la lingua del nuovo memo. Produci tutti i campi di testo libero (per esempio il "text" degli elementi o i paragrafi riassuntivi) nella STESSA lingua del memo.
   - Correggi solo errori evidenti di battitura o spaziatura; non cambiare il significato. Mantieni invariati i nomi propri.
   - Usa la normale capitalizzazione da frase (senza maiuscole casuali).
2) Catalogo tag (quando lo schema prevede `tags`)
   - Scegli 1–3 ID di tag dal catalogo approvato qui sotto. NON inventare nuovi ID.
   - Riporta gli ID esattamente come elencati (rispetta maiuscole/minuscole). Se nessuna opzione è perfetta, scegli l'alternativa più vicina disponibile.
3) Sicurezza e gestione del contesto
   - Non duplicare contenuti già presenti nei dati precedenti.
   - Non incollare copie grezze del memo o del prior: riscrivi sempre in prosa o testo puntato pulito.
   - Usa il JSON strutturato del prior per capire gli elementi esistenti ed emetti solo i cambiamenti introdotti dal nuovo memo.

Quando {aspect} = "lista delle cose da fare":
A) Elementi da restituire
   - Restituisci SOLO il set minimo di attività aggiunte o aggiornate dal nuovo memo (NON l'intera lista).
   - Per ogni elemento scegli "op":
       • "update" se il memo corrisponde semanticamente a un'attività già presente (vedi B).
       • "add" se introduce una nuova attività eseguibile.
   - Quando "op" = "update", includi l'"id" dell'attività dal prior. Quando "op" = "add", NON includere "id".
   - Restituisci sempre almeno un elemento in "items" e imposta "date" ESATTAMENTE a {today}.
B) Regole di corrispondenza (deterministiche)
   - Normalizza per confrontare: tutto in minuscolo, rimuovi accenti, riduci spazi, correggi errori comuni (es. « analysis »→« analisi », « perche »→« perché »).
   - Considera due attività uguali se i testi normalizzati hanno similarità ≳ 0,85 o differiscono solo per refusi / piccole variazioni.
   - In caso di "update", preserva l'intento ma genera un "text" canonico pulito nella lingua del memo.
C) Date nel testo dell'attività
   - Risolvi le date relative (es. « domani », « demain », « mañana ») rispetto a {date}.
   - Se è indicato solo il giorno (es. « il 17 ») usa il mese di {date} se la data è ancora futura; altrimenti passa al mese successivo.
   - Usa "due_date" per le scadenze e "event_date" per eventi pianificati (AAAA-MM-GG). Ometti i campi non applicabili.
D) Stato (deterministico)
   - Valore predefinito: "not_started".
   - Usa "in_progress" solo se il memo dichiara chiaramente che il lavoro è in corso.
   - Usa "done" solo se il memo conferma esplicitamente il completamento.
   - Usa "cancelled" se l'attività non verrà eseguita.
   - Aggiornando un'attività già "done", mantieni "done" a meno che il memo non riapra chiaramente il lavoro.

Quando {aspect} = "lista degli appuntamenti":
   - Riscrivi "updated" con un riepilogo conciso o elenco puntato in ordine cronologico degli appuntamenti aggiornati.
   - In "items" includi solo gli eventi aggiunti o modificati dal memo (non l'intero storico).
   - Per ogni elemento fornisci:
       • "text": un'etichetta breve che unisca tema, data e contesto principale.
       • "datetime": una data o data-ora in formato ISO 8601 (AAAA-MM-GG oppure AAAA-MM-GGTHH:MM) ricavata dal memo.
       • "location": solo se il memo indica una sede o un link di riunione; altrimenti ometti il campo.
   - Se il memo annulla o riprogramma qualcosa, descrivi esplicitamente il nuovo piano sia in "updated" sia nell'elemento corrispondente.

Quando {aspect} = "pensieri e note":
   - Combina il documento Markdown precedente e il nuovo memo per creare una base di conoscenza curata.
   - `updated_markdown`: emetti l'INTERO documento in Markdown, mantenendo le sezioni rilevanti esistenti e integrando i nuovi spunti. Usa livelli di titolo coerenti (es. `#`, `##`, `###`) e lascia una riga vuota dopo i titoli e tra paragrafi/elenco.
   - Mantieni la scrittura focalizzata e sintetica. Riassumi il memo, non citarlo parola per parola, e inserisci il nuovo materiale nelle sezioni appropriate.
   - `sections`: fornisci l'indice ordinato dei titoli. Per ogni sezione indica "title", "level" (1 = `#`), "anchor" (slug stabile in kebab-case) e i "children" annidati che rispecchiano la gerarchia Markdown. Riutilizza un anchor esistente quando il titolo non cambia.
   - `items`: restituisci l'elenco curato di pensieri strutturati da mostrare nell'interfaccia. Ogni elemento deve:
       • Contenere 1–2 frasi di insight nella lingua del memo.
       • Includere 1–3 ID di tag dal catalogo approvato.
       • Rappresentare idee nuove o aggiornate generate dal memo (non copiare l'intero documento).
   - Allinea il testo di ogni elemento al contenuto Markdown in modo che la nota corrisponda chiaramente a una sezione o tema del documento.

Contesto:
- Dati strutturati precedenti:
{prior}

- Data odierna (AAAA-MM-GG): {today}

- Catalogo tag approvato (ID → etichetta):
{tag_catalog}

- Nuovo memo (testo libero da analizzare):
{memo}
